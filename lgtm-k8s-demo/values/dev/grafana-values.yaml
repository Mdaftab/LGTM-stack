# Grafana values for DEV environment
# Chart: grafana/grafana (official)

adminUser: admin
adminPassword: admin

service:
  type: NodePort
  nodePort: 30000
  port: 80

persistence:
  enabled: true
  size: 2Gi

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Pre-provision datasources
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
    - name: Loki
      uid: loki
      type: loki
      access: proxy
      url: http://loki.monitoring.svc.cluster.local:3100
      isDefault: false
      editable: true
      jsonData:
        timeout: 60
        maxLines: 1000
    - name: Tempo
      uid: tempo
      type: tempo
      access: proxy
      url: http://tempo.monitoring.svc.cluster.local:3100
      editable: true
    - name: Prometheus
      uid: prometheus
      type: prometheus
      access: proxy
      url: http://mimir-nginx.monitoring.svc.cluster.local:80/prometheus
      isDefault: true
      editable: true
      jsonData:
        timeInterval: "15s"
    - name: Python-App-Metrics
      uid: python-metrics
      type: prometheus
      access: proxy
      url: http://python-app.development.svc.cluster.local:8000
      editable: true
      jsonData:
        timeInterval: "15s"

# Pre-provision dashboards
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      editable: true
      options:
        path: /var/lib/grafana/dashboards/default

dashboards:
  default:
    lgtm-overview:
      json: |
        {
          "title": "LGTM Overview - DEV",
          "uid": "lgtm-dev",
          "timezone": "browser",
          "refresh": "5s",
          "panels": [
            {
              "type": "logs",
              "title": "Application Logs",
              "datasource": {"type": "loki", "uid": "loki"},
              "targets": [
                {
                  "expr": "{app=\"python-app\", namespace=\"development\"}",
                  "refId": "A"
                }
              ],
              "options": {
                "showTime": true,
                "showLabels": true,
                "sortOrder": "Descending"
              },
              "gridPos": {"h": 10, "w": 24, "x": 0, "y": 0}
            },
            {
              "type": "timeseries",
              "title": "Log Count by Level (per second)",
              "datasource": {"type": "prometheus", "uid": "python-metrics"},
              "targets": [
                {
                  "expr": "sum by (level) (rate(generated_logs_total{environment=\"dev\"}[1m]))",
                  "refId": "A",
                  "legendFormat": "{{level}}"
                }
              ],
              "fieldConfig": {
                "defaults": {
                  "custom": {"fillOpacity": 10}
                }
              },
              "gridPos": {"h": 8, "w": 12, "x": 0, "y": 10}
            },
            {
              "type": "stat",
              "title": "Total Logs Generated",
              "datasource": {"type": "prometheus", "uid": "python-metrics"},
              "targets": [
                {
                  "expr": "sum(generated_logs_total{environment=\"dev\"})",
                  "refId": "A"
                }
              ],
              "gridPos": {"h": 8, "w": 6, "x": 12, "y": 10}
            },
            {
              "type": "gauge",
              "title": "Active Connections",
              "datasource": {"type": "prometheus", "uid": "python-metrics"},
              "targets": [
                {
                  "expr": "active_connections{environment=\"dev\"}",
                  "refId": "A"
                }
              ],
              "options": {
                "min": 0,
                "max": 100
              },
              "gridPos": {"h": 8, "w": 6, "x": 18, "y": 10}
            }
          ]
        }

